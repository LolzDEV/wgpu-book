<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Wgpu Initialization - Wgpu Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Basics</li><li class="chapter-item expanded "><a href="window.html"><strong aria-hidden="true">1.</strong> Window Creation</a></li><li class="chapter-item expanded "><a href="wgpu_init.html" class="active"><strong aria-hidden="true">2.</strong> Wgpu Initialization</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Pipeline</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> Shaders in detail</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Buffers</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Uniforms</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Textures</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Transformations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Coordinate space</div></li><li class="chapter-item expanded affix "><li class="part-title">Intermediate</li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Perspective camera</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Meshes</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Lighting</div></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Snake game</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Wgpu Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="wgpu-initialization"><a class="header" href="#wgpu-initialization">Wgpu initialization</a></h1>
<p>First, we need to add some dependencies to our project</p>
<pre><code class="language-toml">[dependencies]
winit = &quot;0.26&quot;
wgpu = &quot;0.13&quot;
pollster = &quot;0.2&quot;
</code></pre>
<p>As the <a href="https://docs.rs/wgpu/latest/wgpu/">wgpu docs</a> suggest the first thing we need to do to interract with the wgpu crate is to crate an <code>Instance</code>.
Before doing so I'd like to better organize the code so that it's easier to understand what's going on by packing all the rendering related stuff into a structure.</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Renderer {
    surface: wgpu::Surface,
    surface_config: wgpu::SurfaceConfiguration,
    device: wgpu::Device,
    queue: wgpu::Queue,
}
<span class="boring">}
</span></code></pre></pre>
<p>We're going to explain what those structs are more in detail later. Now we need a way to create our renderer.</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Renderer {
    fn new(window: &amp;Window) -&gt; Self {
        let instance = Instance::new(Backends::all());

        ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>And now we're ready to interact with <code>wgpu</code>!</p>
<p>As you might think, since we want to draw stuff on our window we need a <em>surface</em> to draw on, linked to our window. That's exactly what we're going to create now</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Renderer {
    fn new(window: &amp;Window) -&gt; Self {
        let instance = Instance::new(Backends::all());

        let surface = unsafe { instance.create_surface(window) };

        ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>And we got our surface! As you can see the method used to create the surface is unsafe, that's because when using metal (macOS or iOS) if this is called outside the main thread it will crash.</p>
<p>Next we need to get access to our GPU since we want to use it to render stuff on our <code>Surface</code></p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Renderer {
    fn new(window: &amp;Window) -&gt; Self {
        let instance = Instance::new(Backends::all());

        let surface = unsafe { instance.create_surface(window) };
        let adapter = pollster::block_on(instance.request_adapter(&amp;wgpu::RequestAdapterOptions {
            power_preference: PowerPreference::default(),
            force_fallback_adapter: false,
            compatible_surface: Some(&amp;surface),
        }))
        .unwrap();

        let (device, queue) = pollster::block_on(adapter.request_device(
            &amp;wgpu::DeviceDescriptor {
                label: Some(&quot;Device&quot;),
                features: Features::empty(),
                limits: Limits::default(),
            },
            None,
        )).unwrap();

        ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>I know, that's a lot of code, so I'm going to explain what it does. First we are requesting the <code>Adapter</code> which is an handle for our physical GPU, the actual driver, then we are using the <code>Adapter</code> to request a <code>Device</code> which is the software representation of the GPU and a <code>Queue</code>. When we're telling the GPU to do something we are sending <em>commands</em> to the GPU, so we use the <code>Queue</code> to store the commands and then send all of them to the GPU once we need to draw the frame. You also might notice that we are using the <code>pollster::block_on</code> function, this is because the adapter and device creation are <em>asyncronous</em> so since we are in a syncronous contex we need a way to wait for them to complete.</p>
<p>So, what's next? Now we need to tell the surface how it should look like before start doing something on the GPU. We can easily to that with the <code>SurfaceConfiguration</code> structure.</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Renderer {
    fn new(window: &amp;Window) -&gt; Self {
        ...

        let size = window.inner_size();
        let surface_config = SurfaceConfiguration {
            usage: TextureUsages::RENDER_ATTACHMENT,
            format: surface.get_supported_formats(&amp;adapter)[0],
            width: size.width,
            height: size.height,
            present_mode: wgpu::PresentMode::Fifo,
        };

        surface.configure(&amp;device, &amp;surface_config);
        ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Here we go, first we are getting the window inner size (excluding window borders) in pixels and we pass the size into the surface configuration so that the surface is correctly resized, then we also tell the surface to use the first available format from the <code>Adapter</code> since as the docs say, the first format is the preferred one. We also specify that the usage for our texture (surface) is <code>RENDER_ATTACHMENT</code> that's because with this flag we are allowing our texture to be the output of a <code>RenderPass</code>, we will get into what the <code>RenderPass</code> is in the next chapter. Last, we define which mode the surface should use to present our frames, we choose <code>Fifo</code> (VSync). After our configuration is created we call <code>surface.configure</code> to update our surface with the new configuration.</p>
<p>Finally we can construct our <code>Renderer</code></p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Renderer {
    fn new(window: &amp;Window) -&gt; Self {
        ...

        Self {
            surface,
            surface_config,
            device,
            queue,
        }
    }
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="window.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="window.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
